# GitHub Actions: Daily Energy Data Fetch
# Runs every day at 00:30 JST (15:30 UTC)
# Fetches data from TEPCO, Kansai, JEPX, OCCTO and commits to repository
# Vercel will auto-deploy with fresh data

name: Fetch Energy Data

on:
  schedule:
    # Runs at 00:30 JST (15:30 UTC) every day
    - cron: '30 15 * * *'

  # Manual trigger for backfilling or testing
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to fetch (YYYY-MM-DD), leave empty for today'
        required: false
        type: string

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow git push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Install dependencies
        working-directory: ./backend
        run: |
          go mod download
          go mod tidy

      - name: Build fetch binaries
        working-directory: ./backend
        run: |
          echo "ðŸ”¨ Building fetch binaries..."
          go build -o fetch-demand cmd/fetch-demand-http/main.go
          go build -o fetch-jepx cmd/fetch-jepx-http/main.go
          go build -o fetch-reserve cmd/fetch-reserve-http/main.go
          go build -o fetch-weather cmd/fetch-weather/main.go
          go build -o estimate-generation cmd/estimate-generation/main.go
          chmod +x fetch-* estimate-generation

      - name: Determine target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date }}"
          else
            # Fetch data for YESTERDAY (data published next day)
            # Calculate JST date (UTC + 9 hours) minus 1 day
            TARGET_DATE=$(TZ='Asia/Tokyo' date -d 'yesterday' +%Y-%m-%d)
          fi
          echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“… Target date: $TARGET_DATE"

      - name: Create data directories
        run: |
          mkdir -p frontend/public/data/jp/tokyo
          mkdir -p frontend/public/data/jp/kansai
          mkdir -p frontend/public/data/jp/jepx
          mkdir -p frontend/public/data/jp/system
          mkdir -p frontend/public/data/jp/weather

      - name: Fetch Tokyo demand data
        working-directory: ./backend
        run: |
          echo "ðŸ“Š Fetching Tokyo demand data..."
          ./fetch-demand \
            -area tokyo \
            -date ${{ steps.date.outputs.target_date }} \
            --use-http \
            -output ../frontend/public/data/jp/tokyo/demand-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  Tokyo fetch failed (may not be available yet)"

      - name: Fetch Kansai demand data (via OCCTO)
        working-directory: ./backend
        run: |
          echo "ðŸ“Š Fetching Kansai demand data from OCCTO..."
          ./fetch-demand \
            -area kansai \
            -date ${{ steps.date.outputs.target_date }} \
            --use-http \
            -output ../frontend/public/data/jp/kansai/demand-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  Kansai fetch failed"

      - name: Fetch JEPX Tokyo spot prices
        working-directory: ./backend
        run: |
          echo "ðŸ’´ Fetching JEPX Tokyo spot prices..."
          ./fetch-jepx \
            -area tokyo \
            -date ${{ steps.date.outputs.target_date }} \
            --use-http \
            -output ../frontend/public/data/jp/jepx/spot-tokyo-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  JEPX Tokyo fetch failed (may not be available yet)"

      - name: Fetch JEPX Kansai spot prices
        working-directory: ./backend
        run: |
          echo "ðŸ’´ Fetching JEPX Kansai spot prices..."
          ./fetch-jepx \
            -area kansai \
            -date ${{ steps.date.outputs.target_date }} \
            --use-http \
            -output ../frontend/public/data/jp/jepx/spot-kansai-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  JEPX Kansai fetch failed (may not be available yet)"

      - name: Fetch reserve capacity data
        working-directory: ./backend
        run: |
          echo "ðŸ”‹ Fetching reserve capacity data..."
          ./fetch-reserve \
            -date ${{ steps.date.outputs.target_date }} \
            -output ../frontend/public/data/jp/system/reserve-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  Reserve fetch failed (may not be available yet)"

      - name: Fetch Tokyo weather forecast
        working-directory: ./backend
        run: |
          echo "ðŸŒ¤ï¸  Fetching Tokyo weather forecast..."
          ./fetch-weather \
            -area tokyo \
            -date ${{ steps.date.outputs.target_date }} \
            -output ../frontend/public/data/jp/weather/weather-tokyo-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  Tokyo weather fetch failed"

      - name: Fetch Kansai weather forecast
        working-directory: ./backend
        run: |
          echo "ðŸŒ¤ï¸  Fetching Kansai weather forecast..."
          ./fetch-weather \
            -area kansai \
            -date ${{ steps.date.outputs.target_date }} \
            -output ../frontend/public/data/jp/weather/weather-kansai-${{ steps.date.outputs.target_date }}.json \
            || echo "âš ï¸  Kansai weather fetch failed"

      - name: Generate Tokyo generation mix
        working-directory: ./backend
        run: |
          echo "âš¡ Generating Tokyo generation mix..."
          DEMAND_FILE="../frontend/public/data/jp/tokyo/demand-${{ steps.date.outputs.target_date }}.json"
          JEPX_FILE="../frontend/public/data/jp/jepx/spot-tokyo-${{ steps.date.outputs.target_date }}.json"
          if [ -f "$DEMAND_FILE" ] && [ -f "$JEPX_FILE" ]; then
            # Copy files to backend for processing
            mkdir -p public/data/jp/tokyo public/data/jp/jepx
            cp "$DEMAND_FILE" public/data/jp/tokyo/
            cp "$JEPX_FILE" public/data/jp/jepx/

            # Generate
            ./estimate-generation -area tokyo -date ${{ steps.date.outputs.target_date }}

            # Copy result to frontend
            cp public/data/jp/tokyo/generation-${{ steps.date.outputs.target_date }}.json ../frontend/public/data/jp/tokyo/
            echo "âœ… Tokyo generation mix created"
          else
            echo "âš ï¸  Skipping Tokyo generation (demand or JEPX data missing)"
          fi

      - name: Generate Kansai generation mix
        working-directory: ./backend
        run: |
          echo "âš¡ Generating Kansai generation mix..."
          DEMAND_FILE="../frontend/public/data/jp/kansai/demand-${{ steps.date.outputs.target_date }}.json"
          JEPX_FILE="../frontend/public/data/jp/jepx/spot-kansai-${{ steps.date.outputs.target_date }}.json"
          if [ -f "$DEMAND_FILE" ] && [ -f "$JEPX_FILE" ]; then
            # Copy files to backend for processing
            mkdir -p public/data/jp/kansai public/data/jp/jepx
            cp "$DEMAND_FILE" public/data/jp/kansai/
            cp "$JEPX_FILE" public/data/jp/jepx/

            # Generate
            ./estimate-generation -area kansai -date ${{ steps.date.outputs.target_date }}

            # Copy result to frontend
            cp public/data/jp/kansai/generation-${{ steps.date.outputs.target_date }}.json ../frontend/public/data/jp/kansai/
            echo "âœ… Kansai generation mix created"
          else
            echo "âš ï¸  Skipping Kansai generation (demand or JEPX data missing)"
          fi

      - name: List fetched files
        run: |
          echo "ðŸ“ Fetched files:"
          find frontend/public/data/jp -name "*.json" -type f -mtime -1 -exec ls -lh {} \;

      - name: Commit data to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add frontend/public/data/jp/

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "ðŸ“­ No new data to commit"
          else
            git commit -m "ðŸ“Š Update energy data for ${{ steps.date.outputs.target_date }}"
            git push
            echo "âœ… Data committed and pushed"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“Š Data Fetch Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${{ steps.date.outputs.target_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files updated:**" >> $GITHUB_STEP_SUMMARY
          find frontend/public/data/jp -name "*${{ steps.date.outputs.target_date }}*.json" -type f 2>/dev/null | while read file; do
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "- \`$file\` ($size)" >> $GITHUB_STEP_SUMMARY
          done || echo "- No files found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Vercel will auto-deploy with updated data" >> $GITHUB_STEP_SUMMARY
